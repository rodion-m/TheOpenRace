@page "/statistics"

@using OpenRace.Features.Payment
@using OpenRace.Entities
@using OpenRace.Data.Ef
@using OpenRace.Data.Specifications
@using OpenRace.Features.Registration
@using BlazorTable
@using System.Drawing
@using Amazon.SimpleEmail.Model

@inherits OpenRace.Features.Auth.ComponentBaseWithSession

@inject NavigationManager NavigationManager
@inject AppConfig AppConfig
@inject MembersRepository MembersRepo
@inject PaymentService PaymentService
@inject RegistrationService RegistrationService
@inject IToastService ToastService

<h1>Статистика</h1>

@if (Session.IsAuthorized())
{
	if (_statisticsData != null)
	{
		<table class="table table-bordered">
			<thead>
			<tr>
				<th scope="col">Дистанция</th>
				<th scope="col">Все</th>
				<th scope="col">Взрослые</th>
				<th scope="col">Дети</th>
				<th scope="col">Мужчины</th>
				<th scope="col">Женщины</th>
				<th scope="col">Мальчики</th>
				<th scope="col">Девочки</th>
			</tr>
			</thead>
			<tbody>
			@* ReSharper disable once RedundantEnumerableCastCall *@
			@foreach (var distanceInfo in AppConfig.AvailableDistances.Cast<AppConfig.DistanceInfo?>().Append(null))
			{
				var distance = distanceInfo?.DistanceMt;
				var distanceS = distance != null ? $"{distance / 1000} км." : "Всего";
				var color = ColorTranslator.ToHtml(distanceInfo?.Color ?? Color.White);
				<tr>
					<th scope="row" style="background-color: @color">@distanceS</th>
					<td>@(_statisticsData.Count(distance))</td>
					<td>@(_statisticsData.Count(distance, children: false))</td>
					<td>@_statisticsData.Count(distance, children: true)</td>
					<td>@_statisticsData.Count(distance, Gender.Male, children: false)</td>
					<td>@_statisticsData.Count(distance, Gender.Female, children: false)</td>
					<td>@_statisticsData.Count(distance, Gender.Male, true)</td>
					<td>@_statisticsData.Count(distance, Gender.Female, true)</td>
				</tr>
			}
			</tbody>
		</table>
		<h3>
			Всего участников:
			@(_statisticsData.AllMembers.Count)
		</h3>
		<hr/>
		<h2>Список участников</h2>
		<Table TableItem="Member" Items="_statisticsData.AllMembers" PageSize="15" ColumnReorder="true">
			<Column TableItem="Member" Title="№" Field="@(x => x.Number)" Sortable="true" Filterable="true" Width="5%"/>
			<Column TableItem="Member" Title="Имя" Field="@(x => x.FullName)" Sortable="true" Filterable="true" Width="30%"/>
			<Column TableItem="Member" Title="Email" Field="@(x => x.Email)" Sortable="true" Filterable="true" Width="20%">
				<Template>
					<a href="mailto:@context.Email">@context.Email</a>
				</Template>
			</Column>
			<Column TableItem="Member" Title="Телефон" Field="@(x => x.Phone)" Sortable="true" Filterable="true" Width="20%">
				<Template>
					<a href="tel:@context.Phone">@context.Phone</a>
				</Template>
			</Column>
			<Column TableItem="Member" Title="Дистанция (км)" Field="@(x => x.Distance)" Sortable="true" Filterable="true" Width="10%" Format="N0">
				<Template>
					<span>@(context.Distance / 1000)</span>
				</Template>
			</Column>
			<Column TableItem="Member" Title="Возраст" Field="@(x => x.Age)" Sortable="true" Filterable="true" Width="10%"/>
			<Column TableItem="Member" Title="Пол" Field="@(x => x.Gender)" Sortable="true" Filterable="true" Width="5%">
				<Template>
					@{
						var gen = context.Gender == Gender.Male ? "М" : "Ж";
						<span>@gen</span>
					}
				</Template>
			</Column>
			<Pager ShowPageNumber="true" ShowTotalCount="true"/>
		</Table>
	}
	else
	{
		<div>Загрузка...</div>
	}
}
else
{
	<div>Требуется авторизация</div>
}

@code {

	private record StatisticsData(List<Member> AllMembers)
	{
		public int Count(int? distance, Gender? gender = null, bool? children = null)
		{
			return AllMembers.Count(it => (distance == null || it.Distance == distance)
			                              && (gender == null || it.Gender == gender)
			                              && (children == null || it.IsChild() == children)
				);
		}
	}

	StatisticsData? _statisticsData;

	protected override async Task OnAuthorizedAsync()
	{
		await base.OnAuthorizedAsync();
		_statisticsData = new StatisticsData(await MembersRepo.AllAsync().OrderByDescending(it => it.CreatedAt).ToListAsync());
		StateHasChanged();
	}

}